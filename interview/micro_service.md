# go-micro 读书笔记
概览
Go Micro提供分布式系统开发的核心库，包含RPC与事件驱动的通信机制。

micro的设计哲学是可插拔的架构理念，她提供可快速构建系统的组件，并且可以根据自身的需求剥离默认实现并自行定制。


## 特性
Go Micro 抽象了分布式系统的细节。以下是主要功能。

#### 服务发现（Service Discovery） - 自动服务注册与名称解析。服务发现是微服务开发中的核心。当服务A要与服务B协作时，它得知道B在哪里。默认的服务发现系统是Consul，而multicast DNS (mdns，组播)机制作为本地解决方案，或者零依赖的P2P网络中的SWIM协议（gossip）。
服务发现常用的框架 
- zookeeper
- eureka
- etcd
- consul go-micro 默认

- 负载均衡（Load Balancing） - 在服务发现之上构建了负载均衡机制。当我们得到一个服务的任意多个的实例节点时，我们要一个机制去决定要路由到哪一个节点。我们使用随机处理过的哈希负载均衡机制来保证对服务请求颁发的均匀分布，并且在发生问题时进行重试。
- 消息编码（Message Encoding） - 支持基于内容类型（content-type）动态编码消息。客户端和服务端会一起使用content-type的格式来对Go进行无缝编/解码。各种各样的消息被编码会发送到不同的客户端，客户端服服务端默认会处理这些消息。content-type默认包含proto-rpc和json-rpc。
- Request/Response - RPC通信基于支持双向流的请求/响应方式，我们提供有抽象的同步通信机制。请求发送到服务时，会自动解析、负载均衡、拨号、转成字节流，默认的传输协议是http/1.1，而tls下使用http2协议。
- 异步消息（Async Messaging） - 发布订阅（PubSub）头等功能内置在异步通信与事件驱动架构中。事件通知在微服务开发中处于核心位置。默认的消息传送使用点到点http/1.1，激活tls时则使用http2。
- 可插拔接口（Pluggable Interfaces） - Go Micro为每个分布式系统抽象出接口。因此，Go Micro的接口都是可插拔的，允许其在运行时不可知的情况下仍可支持。所以只要实现接口，可以在内部使用任何的技术。更多插件请参考：github.com/micro/go-plugins。

## 分布式理论
#### 分布式一致性分类
- 强一致性：写入成功后，立即保证读取的数据一致。
- 弱一致性：写入成功后，不承诺立马读到新数据，也不承诺多久后保持一致，但会在未来某个时间点一致。
- 最终一致性：弱一致性的特例，承诺在一定时间内能达到数据一致。
  1. 因果一致性（Causal consistency）：A通知B，那么B能读取到A更新的值。
  2. 读自己写的（read your writes）：自己写入的数据，自己能读取到最新值。
  3. 会话一致性 （Sessiob consistency）：同一个会话中能读取到最新值。
  4. 单调读一致性（Monotonic read consistency）：后续读取不会返回旧值。
  5. 单调写一致性（Monotonic write consistency）：保证一个进程内的顺序写入。

#### ACID
Atomicity（原子性）
整个事务中的所有操作，要么全部完成，要么全部不完成。事务在执行过程中发生错误，会被回滚到事务开始前的状态。

Consistency（一致性）
一个事务在执行前与执行后，数据库保持一致状态。也就是说从一个一致性到另一个一致性。

Isolation（隔离性）
在并发环境中，事务是相互隔离的，一个事务的执行不受其他事务干扰。
- 读未提交 (Read Uncommitted)
- 读已提交 (Read Committed)
- 可重复读 (Repeatable Read)
- 串行读 (Serializable)

Durability（持久性）
在事务完成以后，该事务对数据库所作的更改便持久的保存在数据库之中，不会被回滚。

#### BASE
BASE就是为了解决关系数据库强一致性引起的问题而引起的可用性降低而提出的解决方案。

- 基本可用（Basically Available）：允许损失部分可用性。
- 软状态（Soft state）：系统中的数据存在中间态，允许数据同步延时。
- 最终一致（Eventually consistent）：数据在一段时间同步后，最后达到一致状态。

#### CAP
- 一致性(consistency)：访问多节点能返回同样的值。
- 可用性(availability)：每个请求都能在有限时间内响应。
- 分区容忍性(partition tolerance)：集群中的某些节点失效后，整个集群还能继续服务。

根据理论，cap 只能满足两个条件。于是只能在 牺牲一致性，牺牲可用性，牺牲分区容忍性中三选二。由于我们是分布式系统，所以分区容忍性又是必备的。所以只能二选一了。
- CP(牺牲可用性): 保证多节点一致性是比较困难的。可以选用 consul，这类工具实现强一致性的键。主要一些金融业务，需要强一致。
- AP(牺牲一致性): 可以满足最终一致性。可以在将来的某个时间所有节点都能看到更新后的数据，但是不会马上发生。参考微博的评论设计，有时候刷新就不会显示自己的评论。
